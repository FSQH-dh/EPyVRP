本算法在PyVRP（0.11.3）版本的基础上进行改进，在第一届辽河杯VRP问题竞赛中获得了第二名了

团队成员：丁航、李航江、陈柏松、董广成

指导老师：罗茂

单位：湖北工业大学

联系邮箱：dinghang@hbut.edu.cn

开源的算法仅供学术交流

![](.\消融实验结果图.png)

## 摘要

本文针对带时间窗车辆路径问题（VRPTW），在开源库 PyVRP 的基础上提出一套“面向车数优先、随后距离细化优化”的两阶段混合进化框架。主要创新点包括：以多臂老虎机（MAB）与锦标赛（Tournament）混合的父代选择策略、支持多子种群并发与迁移的岛屿模型、显著多样化的局部搜索配置与初始解生成。第一阶段以“最小车辆数”为首要目标，在岛屿间通过自适应迁移与严格受控的接受策略快速收敛到小车数解；第二阶段在固定车辆数条件下，以距离为优化目标并引入来自第一阶段的精英解作为迁移种子，进行进一步细化。实验结果表明，所提方法在大规模实例、严格时间窗约束环境下均具有稳健的搜索效率与解质量。

- 代码主体文件：`PyVRP11.py`（流程编排、两阶段求解、I/O）、`mab_genetic.py`（MAB-Tournament 混合选择、岛屿算法、搜索/初始化多样化等）。
- 主要贡献：混合父代选择（温度退火驱动探索-开发平衡与车辆优先奖励成形）、可迁移的并行岛屿模型（隔离期+自适应迁移频率+多层接受策略+多样性保护）、大幅多样化的局部搜索与初始解策略、两阶段优化（车数优先→距离精炼）、以及数值缩放与“可行后延迟停止”的工程机制。

## 问题分析与解决方案

### 1. 研究问题与挑战

- VRPTW 的组合爆炸性：客户数 n 增加导致搜索空间超指数增长；时间窗与容量约束耦合使可行域稀疏、局部极小密布。
- 单一父代选择与局部搜索策略易陷入早熟收敛：开发（exploitation）与探索（exploration）难以动态平衡。
- 多起点与多样性不足：单一邻域参数或算子集难以覆盖不同实例结构（空间、时间窗分布、需求异质性）。
- 工程层面：时间/距离浮点精度误差与停止准则不可控，导致稳定性与复现性不足。

### 2. 整体框架

- 两阶段目标：
  - 阶段一（车辆优化）：以“最小车辆数”为首要目标，距离次之。
  - 阶段二（距离优化）：以“最小距离”为唯一目标（在固定车辆数约束下）。
- 并行岛屿模型：
  - 多个子种群（`ISLAND_CONFIG['num_islands']`）并发进化、共享“迁移队列”，周期性地发送/接收个体。
  - 迁移机制含“最小隔离期”、自适应迁移间隔、严格多层接受策略（车数优先、再比较距离、再在长期停滞时放宽至多样性驱动）。
- 父代选择混合策略（`HybridSelection`）：
  - MAB 选择（UCB + 温度退火）：强调“车辆优先”的奖励成形（routes↓优先，distance/cost 次级），并以温度 T 降低探索强度。
  - 锦标赛选择：在 MAB 效果趋弱或长期无改进时切换，提升开发强度。
  - 周期性评估并自适应切换（以 best cost、routes、无改进轮次为准）。
- 多样化局部搜索与初始解：
  - `DiverseSearchConfigGenerator`：针对每个岛屿生成显著不同的 `NeighbourhoodParams`、节点/路径算子子集与 `SwapStar` 参数，扩大搜索覆盖。
  - `DiverseInitialSolutionGenerator`：随机、最近邻、扫描、聚类、贪心、时间窗感知等多种启发式初始解，且按岛屿注入不同权重分布。
- 工程与稳定性：
  - 全局缩放（`SCALE_FACTOR`）统一处理时间窗、持续时间与距离，消除浮点噪声导致的可行性不稳定。
  - “可行后延迟停止”（`EarlyStopAfterFeasible`）：首次获得可行解后保留一段探索时间，再停止，兼顾速度与解质量。
  - Windows 下多进程安全（`multiprocessing.freeze_support()`）、跨进程解序列化与轻量表示（仅保存 route visits）。

## 算法与复杂度分析

### 1. 混合父代选择（MAB + 锦标赛）

- MAB 选择的上置信界（UCB）引入温度退火 T：
  
  \[
  \text{UCB}_i = \underbrace{\frac{\text{reward}_i}{\text{pulls}_i}}_{\text{开发}} \;+\; \underbrace{c \cdot T \cdot \sqrt{\frac{\ln (N+1)}{\text{pulls}_i}}}_{\text{探索}}
  \]
  
  其中 \(c\) 为探索系数、\(T\) 随迭代冷却（`initial_temperature`, `cooling_rate`）、\(N\) 为总拉臂次数。
- 奖励成形（车辆优先）：
  - 若子代车辆数减少：给予最高级别奖励，并对“创见最优车数记录”加成。
  - 车辆数相同：再看距离改善，显著改善>0.1 给予更高奖励；无距离改善但惩罚成本降低亦给小奖励。
  - 车辆数增加：仅在惩罚成本显著降低时给予微弱奖励，否则惩罚。
  - 可行性转换奖励/惩罚（不可行→可行：高奖励；反之：高惩罚），并基于与最佳车数的差距给予多样性加权。
- 策略切换：
  - 周期性记录两策略近况（cost、routes、无改进轮次），按“车数优先、再比较成本”的准则决定是否切换。
  - 长期无改进强制切换，避免策略固化。

时间与空间复杂度（单岛视角）：
- 设种群规模 P，局部搜索邻域粒度 g，节点数 n。
- 每代选择与交叉 O(1)（含常数次评估与重算适应度）；奖励更新 O(1)。
- 局部搜索主耗时：典型算子以近邻集 g 控制，单次改进轮次期望 O(g)~O(g log g)，总代价近似 O(k·g)（k 为尝试/改进次数，经验上受收敛与算子集影响）。
- 因此单代复杂度近似 O(k·g)；总复杂度 O(I·k·g)，I 为代数。内存为 O(P·n)。

### 2. 岛屿模型与迁移

- 迁移频率自适应：以“停滞计数”驱动（>500、>200 等阈值）自适应缩短迁移间隔；同时引入最小隔离期与随机触发概率，避免同步迁移造成振荡。
- 接受策略分三层：
  - 层1（严格）：仅接受显著更优（车辆数更少，或同车数下距离<0.95×best）的解；距离阶段对距离提升阈值更高（>5%）。
  - 层2（长期停滞放宽）：当停滞>1000 时，接受到 95%（或距离阶段 98%）阈值的改进。
  - 层3（极端停滞+多样性不足）：多样性阈值触发时接受微弱改善（≤1–2%）。
- 复杂度：迁移处理为 O(M)（M 为每次处理的迁移个体数，受队列上限与停滞自适应控制），相较局部搜索代价较小。

并行整体复杂度：
- 设岛屿数 S，并行情况下墙钟时间近似等于单岛时间（忽略同步与队列开销），总代计算量为 S 倍；迁移额外代价与队列操作为线性可控。

### 3. 多样化局部搜索与初始解

- `DiverseSearchConfigGenerator` 为每个岛屿确定性地产生显著不同的搜索配置：
  - `NeighbourhoodParams` 多维扰动与边界约束（权重、`nb_granular`、对称性）。
  - 算子子集剔除策略（极简核心、单算子专精、大规模移动专精、平衡、全覆盖等）。
  - `SwapStar` 的 `overlap_tolerance` 多值离散化。
- `DiverseInitialSolutionGenerator` 提供 O(n log n)（排序类）或 O(n^2)（简单聚类/最近邻）级别的启发式初始解生成，按岛屿配权随机抽样，扩大初始多样性。

### 4. 两阶段流程与早停

- 阶段一（车数优化）：
  - 自多车数起始，逐步递减尝试，优先确保可行性与车数最小；每次尝试时间上限随全局剩余时间自适应。
  - 全局缩放（`SCALE_FACTOR`）统一处理时间/距离/服务时间，避免浮点误差造成的可行性判定波动。
  - 早停（`EarlyStopAfterFeasible`）：首次可行后延迟固定时长（默认 10s/距离阶段 30s）以“冲刺”更优解。
- 阶段二（距离优化）：
  - 固定第一阶段最小车数，引入其“精英解”至迁移队列作为热启动；参数集偏向距离精细化（更高 `custom_distance_weight`、略调 MAB 探索度与切换频率）。
  - 与阶段一同样并行与迁移机制，缩小迁移队列以突出精英解的扩散与局部精修。

## 创新度

- 混合父代选择的“车辆优先”奖励成形与温度退火探索控制
  - 将“车数减少”提升为最高优先级奖励，辅之以距离/惩罚成本的次级奖励与可行性正负激励；
  - 在 UCB 中引入温度参数 T，随时间退火以平衡早期探索与后期开发。
- 自适应策略切换（MAB ↔ 锦标赛）
  - 基于“车数优先、再比较距离/成本”与“无改进轮次”的多指标评估进行切换；在不同搜索阶段动态调整策略重心，缓解单一选择策略的局限。
- 并行岛屿模型的严格迁移控制与多样性保护
  - 设置“最小隔离期”、自适应迁移频率与触发概率，避免全局同步震荡；
  - 三层接受策略从“显著改进”到“停滞放宽”再到“多样性驱动”逐级开启；
  - 多样性度量虽简化（可行解车数方差），但对大规模并行下的种群健康具有工程有效性。
- 强多样性的局部搜索与初始解生成
  - 面向岛屿级差异化的 `NeighbourhoodParams`、算子子集、`SwapStar` 容忍度三维组合，显著扩大可探索空间；
  - 六类启发式初始解混合并按岛屿赋权，形成稳定的“多模态起点覆盖”。
- 两阶段优化与精英解注入
  - 明确将“最小车数”与“最小距离”解耦，通过阶段切换避免目标冲突；
  - 将阶段一精英解作为阶段二的迁移种子，高效继承结构优势并减少冷启动成本。
- 工程稳定性：数值缩放与“可行后延迟停止”
  - 全面缩放时间/距离数据，减少浮点误差干扰可行性判定；
  - 早停延迟机制在保证找到可行解后继续“压榨”改进窗口，兼顾效率与质量。

## 伪代码与实现要点

### 单岛进化主循环（简化）

```text
输入：Data, HybridParams, MigrationQueue, StopCriterion
初始化：Population P（多样化初始解），Best = argmin cost(P)

while not StopCriterion(cost(Best)):
    更新停滞计数与自适应迁移间隔
    if 到达迁移时机且过了隔离期:
        处理迁移接收（多层接受策略）
        发送本岛最优解与多样性候选
    选择父代 Parents ← HybridSelection(P)
    交叉得到 Offspring，并局部搜索改进
    更新奖励（仅 MAB 模式）
    将 Offspring 加入 P，更新 Best
```

### 两阶段调度（简化）

```text
阶段一：车数优化
    for v 从初始车数递减:
        在给定时间预算内运行并行岛屿
        若找到可行解：记录最优（车数、距离），继续尝试更小车数
        剩余时间不足时提前终止

阶段二：距离优化（固定车数）
    将阶段一精英解注入全局迁移队列
    在给定总剩余时间内运行并行岛屿
    返回距离最优解
```

## 结论与展望

本文提出的两阶段混合进化框架，在 PyVRP 基础上从父代选择、并行迁移、多样化局部搜索与初始化、以及工程稳定性多方面进行系统性强化。核心创新在于“车辆优先的奖励成形 + 退火 UCB + 自适应切换”的父代选择思想与“严格迁移控制 + 多层接受 + 多样性保护”的并行岛屿机制。该框架对大规模、强约束的 VRPTW 具有良好的鲁棒性与可扩展性。